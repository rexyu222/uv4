define(['config'], function(tabloidConfig) {

    var NEWS_SITE_ID = 972352687,
        COOKIE_EXPIRY_IN_DAYS = 90,
        COOKIE = 'ckns_pulse=1',
        SURVEY_NEWS_URL = 'http://ecustomeropinions.com/survey/survey.php?sid={siteid}',
        SURVEY_NEWS_TEST_URL = 'http://www.edigitalresearch.com/test/?sid={siteid}&vault=_',
        SURVEY_ARABIC_URL = 'https://www.smartsurvey.co.uk/s/YV2E7/',
        SURVEY_HAUSA_URL = 'https://six.surveys.com/projects/UKC14000152M/start.asp',
        SURVEY_HINDI_URL = 'https://www.smartsurvey.co.uk/s/3I7SZ/',
        SURVEY_MUNDO_URL = 'https://www.smartsurvey.co.uk/s/2Z8FY/',
        SURVEY_PERSIAN_URL = 'https://www.smartsurvey.co.uk/s/0KYX1/',
        SURVEY_PORTUGUESE_URL = 'https://www.smartsurvey.co.uk/s/BPRTN/',
        SURVEY_RUSSIAN_URL = 'https://www.smartsurvey.co.uk/s/ZJO7W/',
        SURVEY_SERBIAN_CYR_URL = 'https://www.smartsurvey.co.uk/s/TF4PS/',
        SURVEY_SERBIAN_LAT_URL = 'https://www.smartsurvey.co.uk/s/F6Z37/',
        SURVEY_THAI_URL = 'https://www.smartsurvey.co.uk/s/6BZ7X/',
        SURVEY_TURKCE_URL = 'https://www.smartsurvey.co.uk/s/8NWLL/',
        SURVEY_ZHONGWEN_SIMP_URL = 'https://www.smartsurvey.co.uk/s/V6G0N/',
        SURVEY_ZHONGWEN_TRAD_URL = 'https://www.smartsurvey.co.uk/s/BRU7C/',
        SURVEY_URDU_URL = 'https://www.smartsurvey.co.uk/s/2KR4X/',
        SURVEY_WS_URL = 'https://www.smartsurvey.co.uk/s/AERYR/';

    var service;

    function doYouFeelLuckyPunk(probability) {
        return (Math.floor(Math.random() * probability) === 0);
    }

    function cookieBannerShown() {
        return !!(document.getElementById('bbccookies-prompt'));
    }

    function recentlySurveyed() {
        return (document.cookie.indexOf(COOKIE) === 0 || document.cookie.indexOf('; ' + COOKIE) !== -1);
    }

    function setClick(id, func) {
        var el = document.getElementById(id);

        if (el.addEventListener) {
            el.addEventListener('click', func, false);
        } else if (el.attachEvent)  {
            el.attachEvent('onclick', func);
        }
    }

    function setPulseCookie() {
        var value, expiry = new Date();
        expiry.setDate(expiry.getDate() + COOKIE_EXPIRY_IN_DAYS);
        value = COOKIE + '; expires=' + expiry.toGMTString() + '; path=/' + service +'; domain=';
        document.cookie = value + 'bbc.co.uk;';
        document.cookie = value + 'bbc.com;';
    }

    function writePanel(override) {
        var content, url, container = document.createElement('div');

        switch (service) {
            case 'news':
                url = (override ? SURVEY_NEWS_TEST_URL : SURVEY_NEWS_URL).replace('{siteid}', NEWS_SITE_ID);
                break;
            case 'arabic':
                url = SURVEY_ARABIC_URL;
                break;
            case 'hausa':
                url = SURVEY_HAUSA_URL;
                break;
            case 'hindi':
                url = SURVEY_HINDI_URL;
                break;
            case 'mundo':
                url = SURVEY_MUNDO_URL;
                break;
            case 'persian':
                url = SURVEY_PERSIAN_URL;
                break;
            case 'portuguese':
                url = SURVEY_PORTUGUESE_URL;
                break;
            case 'russian':
                url = SURVEY_RUSSIAN_URL;
                break;
            case 'serbian/cyr':
                url = SURVEY_SERBIAN_CYR_URL;
                break;
            case 'serbian/lat':
                url = SURVEY_SERBIAN_LAT_URL;
                break;
            case 'thai':
                url = SURVEY_THAI_URL;
                break;
            case 'turkce':
                url = SURVEY_TURKCE_URL;
                break;
            case 'zhongwen/simp':
                url = SURVEY_ZHONGWEN_SIMP_URL;
                break;
            case 'zhongwen/trad':
                url = SURVEY_ZHONGWEN_TRAD_URL;
                break;
            case 'urdu':
                url = SURVEY_URDU_URL;
                break;
            default:
                url = SURVEY_WS_URL;
        }

        content = document.getElementById('orb-pulse-tmpl').innerHTML
                    .replace('<' + '![CDATA[', '')
                    .replace(']]' + '>', '')
                    .replace(/\{\{pulseaccepthref\}\}/g, url);

        container.innerHTML = content;

        if(document.getElementById('blq-pre-mast') === null) {
            var surveyElement = document.createElement('div');
            var containerElement = document.createElement('div');
            var mainElement = document.getElementsByClassName('direction')[0];

            containerElement.setAttribute('id', 'blq-global');
            surveyElement.setAttribute('id', 'orb-pre-mast');
            containerElement.appendChild(surveyElement);
            mainElement.insertBefore(containerElement, mainElement.firstChild);
            document.getElementById('orb-pre-mast').appendChild(container);
        } else {
            document.getElementById('blq-pre-mast').appendChild(container);
        }
    }

    function attachListeners() {
        setClick('pulse-reject', function(e) {
            e = e || window.event;

            setPulseCookie();
            document.getElementById('pulse-container').style.display = 'none';

            if (e.preventDefault) {
                e.preventDefault();
            }
            e.returnValue = false;

            return false;
        });

        setClick('pulse-accept', function(e) {
            setPulseCookie();
            return true;
        });
    }

    return {
        init: function(serviceName, config) {
            if (serviceName === 'zhongwen' || serviceName === 'serbian' || serviceName === 'ukchina') {
                service = serviceName + '/' + tabloidConfig.languageVariant;
            } else {
                service = serviceName;
            }

            if ('getElementById' in document && 'cookie' in document) {
                if (config.override || (!recentlySurveyed() && !cookieBannerShown() && doYouFeelLuckyPunk(config.probability))) {
                    writePanel(config.override);
                    attachListeners();
                }
            }
        }
    };

});
